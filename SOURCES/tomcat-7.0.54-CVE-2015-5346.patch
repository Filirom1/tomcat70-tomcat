--- java/org/apache/catalina/connector/CoyoteAdapter.java.orig	2016-07-06 14:53:28.217385543 -0400
+++ java/org/apache/catalina/connector/CoyoteAdapter.java	2016-07-06 15:02:49.045710268 -0400
@@ -750,6 +750,10 @@
                                 version = ctxt.getWebappVersion();
                                 // Reset mapping
                                 request.getMappingData().recycle();
+                                mapRequired = true;
+                                // Recycle session info in case the correct
+                                // context is configured with different settings
+                                request.recycleSessionInfo();
                                 break;
                             }
                         }
--- java/org/apache/catalina/connector/Request.java.orig	2016-07-06 14:53:28.218385547 -0400
+++ java/org/apache/catalina/connector/Request.java	2016-07-06 14:53:28.222385563 -0400
@@ -494,18 +494,7 @@
         notes.clear();
         cookies = null;
 
-        if (session != null) {
-            try {
-                session.endAccess();
-            } catch (Throwable t) {
-                ExceptionUtils.handleThrowable(t);
-                log.warn(sm.getString("coyoteRequest.sessionEndAccessFail"), t);
-            }
-        }
-        session = null;
-        requestedSessionCookie = false;
-        requestedSessionId = null;
-        requestedSessionURL = false;
+        recycleSessionInfo();
 
         if (Globals.IS_SECURITY_ENABLED || Connector.RECYCLE_FACADES) {
             parameterMap = new ParameterMap<String, String[]>();
@@ -553,11 +542,24 @@
     }
 
 
-    /**
-     * Clear cached encoders (to save memory for Comet requests).
-     */
-    public boolean read()
-        throws IOException {
+    protected void recycleSessionInfo() {
+        if (session != null) {
+            try {
+                session.endAccess();
+            } catch (Throwable t) {
+                ExceptionUtils.handleThrowable(t);
+                log.warn(sm.getString("coyoteRequest.sessionEndAccessFail"), t);
+            }
+        }
+        session = null;
+        requestedSessionCookie = false;
+        requestedSessionId = null;
+        requestedSessionURL = false;
+        requestedSessionSSL = false;
+    }
+
+
+    public boolean read() throws IOException {
         return (inputBuffer.realReadBytes(null, 0, 0) > 0);
     }
 
--- webapps/docs/changelog.xml.orig	2016-07-06 14:53:28.219385551 -0400
+++ webapps/docs/changelog.xml	2016-07-06 15:04:26.761927698 -0400
@@ -55,6 +55,16 @@
   They eventually become mixed with the numbered issues. (I.e., numbered
   issues to not "pop up" wrt. others).
 -->
+<section name="Tomcat 7.0.54-4 (csutherl)">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        Handle the unlikely case where different versions of a web application
+        are deployed with different session settings. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
 <section name="Tomcat 7.0.54-3 (csutherl)">
   <subsection name="Jasper">
     <changelog>
